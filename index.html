<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Swedenbot</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Lora:wght@400;700&family=IM+Fell+English:ital@0;1&display=swap" rel="stylesheet">
    <style>
        body { background-color: #f4f1eb; font-family: 'Lora', serif; }
        .header-font { font-family: 'IM Fell English', serif; }
        .view { display: none; } /* All views are hidden by default */
        .view.active { display: block; }
        .chat-bubble { max-width: 80%; }
        .user-bubble { background-color: #dbeafe; align-self: flex-end; }
        .bot-bubble { background-color: #ffffff; align-self: flex-start; }
        .main-menu-btn {
            background-color: #605A51;
            color: white;
            font-family: 'IM Fell English', serif;
            transition: background-color 0.3s, transform 0.2s;
        }
        .main-menu-btn:hover {
            background-color: #4a443e;
            transform: translateY(-3px);
        }
        .library-btn {
            background-color: #8c7d6e;
            color: white;
            font-family: 'IM Fell English', serif;
            transition: background-color 0.3s;
        }
        .library-btn:hover {
            background-color: #75685a;
        }
    </style>
</head>
<body class="text-gray-800 flex flex-col items-center min-h-screen p-4 sm:p-6">

    <!-- Main Container -->
    <div class="w-full max-w-5xl mx-auto relative">
        
        <!-- Header with Custom Graphic -->
        <header class="text-center my-8 flex flex-col items-center">
            <img src="musicians.png" alt="Swedenbot Logo" class="w-32 h-32 sm:w-48 sm:h-48 mb-4 object-contain">
            <h1 class="header-font text-5xl sm:text-6xl md:text-7xl font-bold text-gray-700">Swedenbot</h1>
        </header>

        <!-- Main Menu View -->
        <div id="main-menu-view" class="view active">
            <div class="flex flex-col items-center space-y-6 mt-12">
                <button id="ask-question-btn" class="main-menu-btn text-3xl sm:text-4xl py-6 px-12 rounded-lg shadow-lg">Ask a Question</button>
                <button id="browse-library-btn" class="main-menu-btn text-3xl sm:text-4xl py-6 px-12 rounded-lg shadow-lg">Browse the Library</button>
            </div>
        </div>
        
        <!-- Library Menu View -->
        <div id="library-menu-view" class="view">
             <button class="back-btn mb-6 bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg">&larr; Back to Main Menu</button>
            <div id="library-category-buttons" class="flex flex-col items-center space-y-4 mt-8">
                <!-- Library category buttons will be inserted here -->
            </div>
        </div>

        <!-- Library Books View -->
        <div id="library-books-view" class="view">
            <button class="back-btn mb-6 bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg">&larr; Back to Library</button>
            <div id="category-container" class="space-y-12"></div>
        </div>

        <!-- Conversation View -->
        <div id="conversation-view" class="view">
            <button class="back-btn mb-6 bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg">&larr; Back to Main Menu</button>
            <div class="bg-white rounded-2xl shadow-xl p-4 sm:p-6">
                <!-- Chat Log -->
                <div id="chat-log" class="h-96 overflow-y-auto mb-4 flex flex-col space-y-4 p-4 border rounded-lg">
                    <!-- Chat messages will be appended here -->
                </div>
                <!-- Reading Panel -->
                <div id="reading-panel" class="hidden">
                    <h3 class="header-font text-2xl font-bold mb-2">Now Reading:</h3>
                    <div id="reading-text" class="p-4 bg-gray-50 rounded-lg max-h-64 overflow-y-auto text-lg"></div>
                </div>
                 <!-- Voice Input Button -->
                <div class="mt-4 text-center">
                    <button id="mic-btn" class="bg-green-600 hover:bg-green-700 text-white p-5 rounded-full shadow-xl transition-transform transform hover:scale-110">
                        <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path><path d="M19 10v2a7 7 0 0 1-14 0v-2"></path><line x1="12" y1="19" x2="12" y2="23"></line></svg>
                    </button>
                    <p id="status-message" class="text-gray-600 text-lg h-8 mt-2"></p>
                </div>
            </div>
        </div>

    </div>
    
    <audio id="audio-player"></audio>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- DOM REFERENCES ---
            const views = document.querySelectorAll('.view');
            const askQuestionBtn = document.getElementById('ask-question-btn');
            const browseLibraryBtn = document.getElementById('browse-library-btn');
            const libraryCategoryButtons = document.getElementById('library-category-buttons');
            const categoryContainer = document.getElementById('category-container');
            const chatLog = document.getElementById('chat-log');
            const readingPanel = document.getElementById('reading-panel');
            const readingText = document.getElementById('reading-text');
            const micBtn = document.getElementById('mic-btn');
            const statusMessage = document.getElementById('status-message');
            const audioPlayer = document.getElementById('audio-player');
            
            // --- APP STATE ---
            let bookList = [];
            let conversationHistory = [];

            // --- BROWSER FEATURE SETUP ---
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            let recognition;
            if (SpeechRecognition) {
                recognition = new SpeechRecognition();
                recognition.continuous = false;
                recognition.lang = 'en-US';
            }

            // --- VIEW MANAGEMENT ---
            function showView(viewId) {
                views.forEach(view => {
                    view.classList.toggle('active', view.id === viewId);
                });
            }

            // --- UI RENDERING ---
            function renderChatMessage(message, isUser) {
                const bubble = document.createElement('div');
                bubble.classList.add('chat-bubble', 'p-4', 'rounded-xl');
                bubble.classList.toggle('user-bubble', isUser);
                bubble.classList.toggle('bot-bubble', !isUser);
                bubble.textContent = message;
                chatLog.appendChild(bubble);
                chatLog.scrollTop = chatLog.scrollHeight; // Auto-scroll to bottom
            }

            function renderReadingText(title, text) {
                readingPanel.classList.remove('hidden');
                readingText.innerHTML = `<p><strong class="header-font">${title}</strong></p><p>${text}</p>`;
            }
            
            function renderLibraryCategories() {
                const categories = [...new Set(bookList.map(book => book.type))];
                libraryCategoryButtons.innerHTML = '';
                categories.forEach(category => {
                    const button = document.createElement('button');
                    button.textContent = category;
                    button.className = 'library-btn text-2xl sm:text-3xl py-4 px-8 rounded-lg shadow-md w-full max-w-md';
                    button.addEventListener('click', () => {
                        renderBookList(category);
                        showView('library-books-view');
                    });
                    libraryCategoryButtons.appendChild(button);
                });
            }

            function renderBookList(category) {
                const booksInCategory = bookList.filter(book => book.type === category);
                let bookCardsHTML = booksInCategory.map(book => `
                    <div class="book-card bg-white rounded-lg shadow-md p-4 cursor-pointer" data-book-id="${book.id}">
                        <h3 class="header-font text-xl font-bold">${book.title}</h3>
                        <p class="text-sm text-gray-600">${book.author} - ${book.language}</p>
                    </div>
                `).join('');

                categoryContainer.innerHTML = `
                    <h2 class="header-font text-4xl font-bold border-b-2 border-gray-300 pb-2 mb-6">${category}</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        ${bookCardsHTML}
                    </div>
                `;

                document.querySelectorAll('.book-card').forEach(card => {
                    card.addEventListener('click', async () => {
                        const bookId = card.dataset.bookId;
                        const book = bookList.find(b => b.id === bookId);
                        renderChatMessage(`User selected: ${book.title}`, true);
                        await sendToAI(`Please open the book titled "${book.title}".`);
                        showView('conversation-view');
                    });
                });
            }

            // --- CONVERSATIONAL AI & AUDIO LOGIC ---
            recognition.onstart = () => { statusMessage.textContent = "Listening..."; micBtn.classList.add('bg-red-600'); };
            recognition.onresult = async (event) => {
                const userText = event.results[0][0].transcript;
                renderChatMessage(userText, true);
                await sendToAI(userText);
            };
            recognition.onend = () => { statusMessage.textContent = "Tap to speak"; micBtn.classList.remove('bg-red-600'); };

            async function sendToAI(text) {
                conversationHistory.push({role: 'user', parts: [{text}]});
                statusMessage.textContent = 'Swedenbot is thinking...';

                // This is a mock response. Replace with your actual backend call.
                // In a real scenario, the backend would handle the logic and TTS.
                setTimeout(() => {
                    const aiResponseText = `This is a simulated response to: "${text}". The backend is not connected.`;
                    renderChatMessage(aiResponseText, false);
                    conversationHistory.push({role: 'model', parts: [{text: aiResponseText}]});
                    statusMessage.textContent = "Tap to speak";
                }, 1500);
            }
            
            // --- INITIALIZATION ---
            async function initialize() {
                try {
                    const response = await fetch('./data/books.json');
                    if (!response.ok) throw new Error('Could not load books.json');
                    const data = await response.json();
                    bookList = data.books;
                    renderLibraryCategories();
                } catch (error) {
                    console.error("Initialization Error:", error);
                    libraryCategoryButtons.innerHTML = `<p class="text-center text-red-500">Error loading library.</p>`;
                }
            }

            // --- EVENT LISTENERS ---
            askQuestionBtn.addEventListener('click', () => {
                showView('conversation-view');
                if (conversationHistory.length === 0) {
                     renderChatMessage("Hello! How can I help you explore the works of Emanuel Swedenborg today?", false);
                }
            });
            browseLibraryBtn.addEventListener('click', () => showView('library-menu-view'));
            micBtn.addEventListener('click', () => recognition.start());
            
            document.querySelectorAll('.back-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    if (document.getElementById('library-books-view').classList.contains('active')) {
                        showView('library-menu-view');
                    } else {
                        showView('main-menu-view');
                    }
                });
            });

            initialize();
        });
    </script>
</body>
</html>
